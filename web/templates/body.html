{% load static %}
<!-- Include jQuery and Select2 CSS/JS files -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div id="map" class="map"></div>

    <div id="legend" style="position: absolute; bottom: 20px; left: 20px; background: rgba(255, 255, 255, 0.8); padding: 10px;">
      <h3><b>Legend</b></h3>
    </div>

    <div id="layer-selection" style="position: absolute; top: 85px; right: 20px; background: rgba(255, 255, 255, 0.8); padding: 10px;">
        <h3>Area Feature (Choose one)</h3>
        <select id="area-layer-dropdown">
          <option>Select Area Feature</option>
          <!-- Add options for area layers -->
        </select>

          <button class="details-btn" id="area-details-button" style="visibility: hidden;">More</button>

        <h3>Highway Features (Choose multiple)</h3>
        <button class="toggle-button" data-target="highway-flow-checkboxes">Show Highway Flows</button>
        <div id="highway-flow-checkboxes" style="display: none;">
          <!-- Add checkboxes for highway flows -->
        </div>

        <br><br>
          <button class="toggle-button" data-target="highway-infra-checkboxes">Show Planned Infrastructure Corridors</button>
        <div id="highway-infra-checkboxes" style="display: none;">
          <!-- Add checkboxes for highway flows -->
        </div>

        <h3>Point Features (Choose multiple)</h3>
        <button class="toggle-button" data-target="point-refuel-checkboxes">Show Charge/Fuel Stations</button>
        <div id="point-refuel-checkboxes" style="display: none;">
          <!-- Add checkboxes for point layers -->
        </div>

        <br><br>

          <button class="toggle-button" data-target="point-h2prod-checkboxes">Show Hydrogen Production Facilities</button>
        <div id="point-h2prod-checkboxes" style="display: none;">
          <!-- Add checkboxes for point layers -->
        </div>

        <br><br>

          <button class="toggle-button" data-target="point-other-checkboxes">Show Other Point Features</button>
        <div id="point-other-checkboxes" style="display: none;">
          <!-- Add checkboxes for point layers -->
        </div>


        <div class="button-container">
          <div class="apply-button-wrapper">
            <button id="apply-button" class="apply-button">Apply</button>
            <div class="spinner-circle" id="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
          </div>
          <button id="clear-button" class="clear-button">Clear Layers</button>
        </div>

    </div>
    <div id="uploaded-layer-selection" style="position: absolute; top: 10px; left: 40px; background: rgba(255, 255, 255, 0.8); padding: 10px; {% if not uploaded_files%} display:none {%endif%}">
      <select id="usefiles-data-ajax"  multiple="multiple" style="width: 100%;">
      </select>
    </div>

<!-- Initialize Select2 -->
<script>
    let uploadedGeojsonNames = {};
    $(document).ready(function() {
        const $select = $('#usefiles-data-ajax');

        $select.select2({
          placeholder: 'Select one or more uploaded layers',
          allowClear: true,
          ajax: {
            cache: true,
            delay: 250,
            dataType: 'json',
            url: '{{uploaded_files}}',
            headers: { "Content-Type": "application/json" },
            processResults: function (data) {
              const kv = []
              for (const item of data.data) {
                const geojsonFile = item.files.find(file => file.file_link.includes('.geojson'));
                if (geojsonFile) {
                  kv.push({ text: item.name, id: geojsonFile.file_link });
                }
              }
              return { results: kv, pagination: { more: data.next_page || false } };
            },
            data: function (params) {
              return { search_query: params.term, page: params.page };
            }
          },
          templateSelection: function (data) {
            const container = document.createElement('span');
            container.classList.add('uploaded-layer-pill');
            container.style.display = 'flex';
            container.style.alignItems = 'center';

            const textNode = document.createElement('span');
            textNode.textContent = data.text;

            const moreButton = document.createElement('button');
            moreButton.textContent = 'More';
            moreButton.classList.add('details-btn');
            moreButton.setAttribute('data-key', data.text);
            moreButton.style.marginLeft = '40px';

            container.appendChild(textNode);
            container.appendChild(moreButton);

            return container;
          }
        });

        const addPlaceholder = () => {
            const selectionContainer = $select.next('.select2-container').find('.select2-selection__rendered');
            const existingPlaceholder = selectionContainer.find('.select2-placeholder-custom');
            if ($select.val() && $select.val().length > 0) {
                if (existingPlaceholder.length === 0) {
                    const placeholder = $('<li class="select2-placeholder-custom">Select one or more uploaded layers</li>');
                    placeholder.css({
                      color: '#a9a9a9',                 // Match default placeholder grey
                      marginTop: '5px',
                      paddingLeft: '6px',            // Match left padding of choices
                      display: 'block',              // Ensure it spans full width
                      listStyle: 'none',
                      width: '100%',
                      fontSize: '18px'               // Ensure font size matches
                    });
                    selectionContainer.append(placeholder);
                }
            } else {
                existingPlaceholder.remove();
            }
        };

        // Call after Select2 finishes rendering selections
        $select.on('select2:select select2:unselect', function() {
            setTimeout(addPlaceholder, 0);
        });

        // Initial call on page load
        addPlaceholder();
    });
</script>

</div>

<div id="details-modal" class="modal">
<div class="modal-content">
  <span class="close-btn">&times;</span>
  <h2 id="details-title">Details</h2>
  <p id="details-content">Details content goes here.</p>
</div>
</div>

<!-- Modal for displaying regulations -->
<div id="regulations-modal" class="modal">
  <div id="regulations-content" class="modal-content">
    <span class="close-regulations">&times;</span>
    <h1>Regulations and Incentives for [State Name]</h1>
    <p><em>Click on targets to view more information.</em></p>
    <div id="regulations-details">
      <p>Loading...</p>
      <p><em>Italicized regulations and incentives benefit multiple fuel types and appear multiple times.</em></p>
    </div>
  </div>
</div>

<!-- Stuff Displaying DOE Plan, on pause -->
<script>
  const GET_GEOJSONS = '{% url "get-geojsons" %}';
  const GET_GEOJSON = '{% url "get-geojson" %}';
  const STORAGE_URL = 'https://mcsc-datahub-public.s3.us-west-2.amazonaws.com/';
  const CSV_URL = 'https://raw.githubusercontent.com/mcsc-impact-climate/FAF5-Analysis/main/data/incentives_and_regulations/state_level/';
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script type="module"  src='{% static "main.js"%}'></script>
